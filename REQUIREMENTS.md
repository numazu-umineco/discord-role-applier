# 要件定義

## プロジェクト概要

Discord上でチャンネル・スレッドの発言者全員に、選択したロールを一括付与するBot。メッセージ右クリックから実行し、Ephemeralメッセージでロール選択・確認を行う。

## 主要機能

### 1. コマンド実行
- Message Context Menu Command（メッセージ右クリック）で実行
- コマンド名は環境変数で設定可能（デフォルト: `発言者にロールを適用する`）
- スレッド・チャンネル両方に対応

### 2. メッセージ履歴取得
- 最大1000件のメッセージ履歴を取得（環境変数で変更可）
- ボット・システムメッセージを除外
- 退出済みユーザーを除外
- 重複排除してユニークな発言者リストを作成

### 3. ロール選択UI
- StringSelectMenuでロール選択
- 付与可能なロールのみ表示（@everyone、managed、Bot上位ロールを除外）
- Ephemeralメッセージ（実行者のみに表示）

### 4. 確認画面
- 対象チャンネル/スレッド名、ロール名、対象人数を表示
- 最大30人のメンション表示（それ以上は「他XX人」）
- チャンネル全体の場合は警告表示
- 「実行」「キャンセル」ボタンで最終確認

### 5. 権限チェック
- コマンド実行権限: `REQUIRED_ROLE_IDS`で指定（空欄で全員許可）
- ロール管理権限: `MANAGE_ROLES`権限と自分の最上位ロールより下位のみ
- Bot権限: Botの最上位ロールより下位のみ付与可能
- サーバーオーナーは常に全権限

### 6. ロール一括付与
- 既にロール保持済みのユーザーはスキップ
- 100ms間隔で順次付与（レート制限対策）
- 成功/失敗/スキップ件数を集計

### 7. 結果表示
- 対象チャンネル名、ロール名、処理結果を表示
- Ephemeralメッセージで実行者のみに表示

## 技術スタック

- **言語**: TypeScript 5.x
- **ライブラリ**: discord.js v14
- **ランタイム**: Node.js 20
- **ロギング**: console (stdout/stderr)
- **コンテナ**: Docker / docker-compose

## 主要な制約

### Discord API制約
- メッセージ取得: 100件/リクエスト
- SelectMenuオプション: 25個まで
- メッセージ文字数: 2000文字まで
- Interaction応答期限: 15分

### 運用制約
- Botのロールは付与対象ロールより上位に配置必須
- Privileged Intents（SERVER MEMBERS, MESSAGE CONTENT）の有効化必須
- `MANAGE_ROLES`権限をBotに付与必須

## 将来的な拡張案

- ロール除去機能
- 複数ロール同時付与
- 期間指定でのメッセージ取得
- 実行履歴の記録
