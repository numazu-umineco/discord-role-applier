# 要件定義書

## 1. プロジェクト概要

Discord上で特定のチャンネルで発言した全員に対して、指定したロールを一括付与するBot。

### 目的
- チャンネルの参加者を素早く特定し、ロールを効率的に付与する
- イベント参加者や特定のトピックに関わった人を簡単に管理できるようにする

### 対象ユーザー
- Discordサーバーの管理者
- モデレーター
- イベント運営者

---

## 2. 機能要件

### 2.1 コマンド実行（FR-001）

**概要**: メッセージコンテキストメニューからコマンドを実行

**詳細要件**:
- Discord UIでメッセージを右クリック→「アプリ」メニューから実行可能
- コマンド名: `Apply Role to Participants`
- コマンドタイプ: Message Context Menu Command
- 実行可能場所: サーバー内のテキストチャンネルのみ

**前提条件**:
- Botがサーバーに招待済み
- Botに必要な権限が付与されている（Manage Roles, Read Messages, Read Message History）

**成功条件**:
- コマンド実行後、Ephemeralメッセージが表示される
- メッセージ履歴の取得が開始される

---

### 2.2 メッセージ履歴取得（FR-002）

**概要**: コマンド実行されたチャンネルのメッセージ履歴を取得し、発言者を抽出

**詳細要件**:
- 最大1000件のメッセージを取得（環境変数で変更可能）
- 100件ずつバッチ取得（Discord API制限に対応）
- 古いメッセージから新しいメッセージへ遡って取得
- ボットの発言を除外
- システムメッセージを除外
- 重複ユーザーを排除（ユニーク化）
- サーバーから退出済みのユーザーを除外

**前提条件**:
- Botがチャンネルの閲覧権限を持つ
- Botがメッセージ履歴の閲覧権限を持つ

**成功条件**:
- 発言者リストが正確に取得される
- 処理中にローディング表示がされる
- 取得完了後、発言者数が表示される

**エッジケース**:
- チャンネルにメッセージが1件もない場合 → エラーメッセージ表示
- 発言者が全員退出済みの場合 → エラーメッセージ表示
- 1000件以上メッセージがある場合 → 最新1000件のみ取得

---

### 2.3 ロール選択UI（FR-003）

**概要**: 付与するロールを選択するUIを表示

**詳細要件**:
- StringSelectMenuで表示
- 最大25個のロールを表示（Discord制限）
- Ephemeralメッセージ（実行者のみに表示）
- 付与可能なロールのみ表示
  - @everyoneロールを除外
  - Botより上位のロールを除外
  - managed（Bot専用）ロールを除外
- ロールはポジションの高い順に表示

**前提条件**:
- サーバーに付与可能なロールが1つ以上存在する
- Botのロールが付与対象ロールより上位に配置されている

**成功条件**:
- ロール選択メニューが表示される
- ロール名が正しく表示される
- ロール選択後、確認画面に遷移する

**エラー条件**:
- 付与可能なロールが0個の場合 → エラーメッセージ表示

---

### 2.4 確認画面（FR-004）

**概要**: ロール選択後、実行前に確認画面を表示

**詳細要件**:
- 選択したロール名を表示
- 対象チャンネル名を表示
- 「実行」ボタンと「キャンセル」ボタンを表示
- ボタンにはアイコン（✅/❌）を付与

**前提条件**:
- ロール選択が完了している

**成功条件**:
- 確認画面が表示される
- 実行ボタン押下でロール付与が開始される
- キャンセルボタン押下で処理が中止される

---

### 2.5 権限チェック（FR-005）

**概要**: コマンド実行者とBotの権限を検証

**詳細要件**:

#### コマンド実行権限
- 環境変数`REQUIRED_ROLE_IDS`で指定されたロールを持つユーザーのみ実行可能
- 空欄の場合は全員が実行可能
- サーバーオーナーは常に実行可能

#### ロール管理権限（ユーザー）
- `MANAGE_ROLES`権限を持つユーザーのみ実行可能
- 自分の最上位ロールより下位のロールのみ付与可能
- サーバーオーナーは全てのロールを付与可能

#### ロール管理権限（Bot）
- Botの最上位ロールより下位のロールのみ付与可能

**成功条件**:
- 権限がある場合のみ処理が続行される
- 権限がない場合はエラーメッセージが表示される

**エラーメッセージ**:
- コマンド実行権限なし: 「このコマンドを実行する権限がありません」
- ロール管理権限なし: 「このロールを管理する権限がありません」
- Bot権限不足: 「Botがこのロールを付与する権限を持っていません」

---

### 2.6 ロール一括付与（FR-006）

**概要**: 発言者全員に選択したロールを付与

**詳細要件**:
- 複数ユーザーに対して順次ロールを付与
- 既にロールを持つユーザーはスキップ
- 各ユーザー間で100msの待機時間を設ける（レート制限対策）
- 成功/失敗/スキップの件数を記録

**前提条件**:
- 権限チェックが完了している
- 発言者リストが取得済み

**成功条件**:
- 全ユーザーへの処理が完了する
- 結果が正確に表示される

**エラーハンドリング**:
- 個別のユーザーで失敗しても他のユーザーへの処理は継続
- 失敗したユーザー情報をログに記録

---

### 2.7 結果表示（FR-007）

**概要**: ロール付与結果をフィードバック

**詳細要件**:
- 対象チャンネル名を表示
- 付与したロール名を表示
- 成功件数を表示
- スキップ件数を表示（既に保持していたユーザー）
- 失敗件数を表示（失敗がある場合のみ）

**成功条件**:
- 結果が正確に表示される
- Ephemeralメッセージで表示（実行者のみに見える）

---

## 3. 非機能要件

### 3.1 パフォーマンス（NFR-001）

**応答時間**:
- コマンド実行から最初の応答まで: 1秒以内
- メッセージ履歴取得（100件）: 5秒以内
- メッセージ履歴取得（1000件）: 30秒以内
- ロール付与（10人）: 5秒以内
- ロール付与（50人）: 30秒以内

**スループット**:
- 同時実行数: 制限なし（Discordの仕様に依存）

---

### 3.2 可用性（NFR-002）

**稼働率**:
- 目標稼働率: 99%以上（Discordサービスが正常な場合）

**再起動**:
- コンテナ異常終了時の自動再起動機能
- エラー発生時もBot自体は停止しない

---

### 3.3 セキュリティ（NFR-003）

**認証・認可**:
- Discord OAuth2による認証
- ロールベースのアクセス制御
- ロール階層に基づく権限管理

**データ保護**:
- Bot Tokenの環境変数管理
- .envファイルのGit除外
- ログにセンシティブ情報を出力しない

**実行環境**:
- 非rootユーザーでコンテナ実行

---

### 3.4 保守性（NFR-004）

**ロギング**:
- Winston による構造化ロギング
- ログレベル: debug, info, warn, error
- 本番環境ではファイル出力
- エラー時はスタックトレースを記録

**コード品質**:
- TypeScriptによる型安全性
- ESLintによる静的解析
- Prettierによるコードフォーマット

**ドキュメント**:
- README.md（セットアップ手順）
- REQUIREMENTS.md（要件定義）
- ARCHITECTURE.md（アーキテクチャ設計）
- コード内JSDocコメント

---

### 3.5 移植性（NFR-005）

**環境依存**:
- Node.js 20以上
- Docker / Docker Compose対応
- 環境変数による設定管理

**デプロイ**:
- Dockerイメージでポータブル
- docker-composeで簡単起動
- 複数サーバーでの並行稼働可能

---

### 3.6 スケーラビリティ（NFR-006）

**水平スケーリング**:
- 複数インスタンスの同時稼働可能
- ステートレス設計

**垂直スケーリング**:
- メモリ使用量: 100MB以下（通常時）
- CPU使用率: 5%以下（アイドル時）

---

### 3.7 UX/UI（NFR-007）

**ユーザーフレンドリー**:
- Ephemeralメッセージで他のユーザーに影響なし
- 明確なエラーメッセージ
- 処理中のローディング表示
- 確認画面による誤操作防止

**応答性**:
- インタラクションに即座に反応
- メッセージ更新方式で画面がスッキリ

---

## 4. 制約事項

### 4.1 Discord API制約

- メッセージ取得: 100件/リクエスト
- レート制限: 50リクエスト/秒
- SelectMenuのオプション: 25個まで
- Ephemeralメッセージの有効期限: 15分

### 4.2 技術的制約

- Node.js環境が必要
- Discord.js v14以上
- Dockerが利用可能な環境

### 4.3 運用制約

- Botのロールは付与対象ロールより上位に配置が必須
- Privileged Intentsの有効化が必須
- サーバー管理者による初期設定が必要

---

## 5. 将来的な拡張可能性

### 考慮されている拡張
- ロール除去機能
- 複数ロール同時付与
- 期間指定でのメッセージ取得
- 対象ユーザーフィルタリング（リアクションしたユーザーなど）
- コマンド実行履歴の記録

### アーキテクチャ上の準備
- モジュール分離設計
- サービス層の抽象化
- エラーハンドリングの統一
